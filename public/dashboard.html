<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Lojas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .filters {
            background-color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            margin-bottom: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .filter-row {
            display: flex;
            gap: 12px;
            margin-bottom: 0;
            align-items: center;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        .filter-group label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        .filter-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
        }
        .filter-input {
            padding: 12px 14px;
            height: 42px;
            font-size: 16px;
            line-height: 22px;
            border: 1px solid #cfd8dc;
            border-radius: 10px;
            flex: 1;
            background-color: #fff;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            overflow-y: auto;
        }
        .filter-input::placeholder {
            color: #9aa0a6;
        }
        .filter-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
            background-color: #fff;
        }
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }
        .filter-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .filter-btn:hover {
            background-color: #45a049;
        }
        .clear-btn {
            background-color: #f44336;
        }
        .clear-btn:hover {
            background-color: #d32f2f;
        }
        table {
            width: max-content;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            table-layout: auto;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
            min-width: 140px;
        }
        th {
            background-color: #4CAF50;
            color: white;
            position: sticky;
            top: 0;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .row-alert {
            background-color: #ffebee !important;
            color: #b00020;
        }
        .row-replicar-old {
            background-color: #e3f2fd !important;
            color: #0d47a1 !important;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
        .error {
            color: red;
            text-align: center;
            padding: 20px;
        }
        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            height: calc(100vh - 160px);
            -webkit-overflow-scrolling: touch;
        }
        /* Scrollbar (WebKit) */
        .table-container::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #eee;
            border-radius: 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #bbb;
            border-radius: 8px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a6a6a6;
        }
        @media (max-width: 1024px) {
            th, td { min-width: 120px; }
        }
        @media (max-width: 768px) {
            body { padding: 12px; }
            .filters { padding: 10px 12px; margin-bottom: 8px; border-radius: 8px; }
            .filter-row { gap: 10px; }
            .filter-input { font-size: 14px; height: 40px; }
            th, td { min-width: 110px; padding: 6px; }
        }
        @media (max-width: 480px) {
            .filter-input { font-size: 14px; height: 38px; }
            th, td { min-width: 100px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Filtros -->
        <div class="filters">
            <div class="filter-row">
                <input type="text" id="searchFilter" class="filter-input" placeholder="Filtrar por banco ou loja...">
            </div>
        </div>
    </div>
        
        <div class="table-container">
            <table id="lojasTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ID Loja</th>
                        <th>Banco</th>
                        <th>Backup</th>
                        <th>Loja</th>
                        <th>Último Erro Replicar</th>
                        <th>Último Erro Integração</th>
                        <th>Qtd Registros Replicar</th>
                        <th>Replicar</th>
                        <th>Reg Local</th>
                        <th>Reg Servidor</th>
                        <th>Versão Sinc</th>
                        <th>Tempo Gasto Replicar</th>
                        <th>Reg Integração</th>
                        <th>Versão L</th>
                        <th>Versão Pro</th>
                        <th>Versão Omnni</th>
                        <th>Versão Lite</th>
                        <th>Versão Paralelo</th>
                        <th>Versão Dunamis</th>
                        <th>Versão Integração</th>
                        <th>Versão Atualizador</th>
                        <th>Versão Temp</th>
                        <th>IP VPN</th>
                        <th>Integração</th>
                    </tr>
                </thead>
                <tbody id="lojasTableBody">
                    <tr>
                        <td colspan="25" class="loading">Carregando dados...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Variável para armazenar todos os dados
        let allLojas = [];
        
        // Aplicar ordenação por cor somente na primeira chamada
        let firstSortApplied = false;
        
        // Funções auxiliares para classificação de cor
        function isRowAlertRed(loja) {
            const reglocal = Number(loja.reglocal || 0);
            const regintegracao = Number(loja.regintegracao || 0);
            const regservidor = Number(loja.regservidor || 0);
            const hasRegs = reglocal > 0 || regintegracao > 0 || regservidor > 0;
            const erroReplicar = (loja.ultimoerrorelicar && String(loja.ultimoerrorelicar).trim() !== '');
            const erroIntegracao = (loja.ultimoerrointegracao && String(loja.ultimoerrointegracao).trim() !== '');
            const hasErrors = erroReplicar || erroIntegracao;
            return hasRegs && hasErrors;
        }
        
        function isReplicarOld(loja) {
            const replicarStr = (typeof loja.replicar === 'string') ? loja.replicar.trim() : '';
            if (!replicarStr) return false;
            const isoStr = replicarStr.replace(' ', 'T') + '-03:00';
            const replicarDate = new Date(isoStr);
            if (isNaN(replicarDate.getTime())) return false;
            const diffMs = Date.now() - replicarDate.getTime();
            const oneHourMs = 60 * 60 * 1000;
            return diffMs > oneHourMs;
        }
        
        function sortLojasByColor(lojas) {
            const reds = [];
            const blues = [];
            const normals = [];
            for (const loja of lojas) {
                if (isRowAlertRed(loja)) {
                    reds.push(loja);
                } else if (isReplicarOld(loja)) {
                    blues.push(loja);
                } else {
                    normals.push(loja);
                }
            }
            return reds.concat(blues, normals);
        }
        
        // Função para carregar os dados das lojas
        async function loadLojas(silent = false) {
            const tableBody = document.getElementById('lojasTableBody');
            if (!silent) {
                tableBody.innerHTML = '<tr><td colspan="25" class="loading">Carregando dados...</td></tr>';
            }
            
            try {
                const response = await fetch('/lojas?limit=10000');
                const data = await response.json();
                
                if (data.success) {
                    allLojas = data.result;
                    // Ordenar por cor na primeira chamada: vermelho > azul > normal
                    if (!silent && !firstSortApplied) {
                        allLojas = sortLojasByColor(allLojas);
                        firstSortApplied = true;
                    }
                    // Aplicar mesma ordenação também nos refreshs (silent)
                    if (silent) {
                        allLojas = sortLojasByColor(allLojas);
                    }
                    const input = document.getElementById('searchFilter');
                    const hasSearch = input && input.value.trim().length > 0;
                    if (hasSearch) {
                        applyFilters();
                    } else {
                        displayLojas(allLojas);
                    }
                } else {
                    if (!silent) {
                        tableBody.innerHTML = '<tr><td colspan="25" class="error">Erro ao carregar dados: ' + (data.errors ? data.errors[0].message : 'Erro desconhecido') + '</td></tr>';
                    }
                }
            } catch (error) {
                if (!silent) {
                    tableBody.innerHTML = '<tr><td colspan="25" class="error">Erro ao carregar dados: ' + error.message + '</td></tr>';
                }
            }
        }
        
        // Função para exibir as lojas na tabela
        function displayLojas(lojas) {
            const tableBody = document.getElementById('lojasTableBody');
            
            if (lojas.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="25" class="loading">Nenhuma loja encontrada.</td></tr>';
                return;
            }
            
            // Limpar a tabela
            tableBody.innerHTML = '';
            
            // Preencher a tabela com os dados
            lojas.forEach(loja => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${loja.id || ''}</td>
                    <td>${loja.idloja || ''}</td>
                    <td>${loja.banco || ''}</td>
                    <td>${loja.backup || ''}</td>
                    <td>${loja.loja || ''}</td>
                    <td>${loja.ultimoerrorelicar || ''}</td>
                    <td>${loja.ultimoerrointegracao || ''}</td>
                    <td>${loja.qdtregistrosreplicar !== undefined ? loja.qdtregistrosreplicar : ''}</td>
                    <td>${loja.replicar || ''}</td>
                    <td>${loja.reglocal !== undefined ? loja.reglocal : ''}</td>
                    <td>${loja.regservidor !== undefined ? loja.regservidor : ''}</td>
                    <td>${loja.versaosinc || ''}</td>
                    <td>${loja.tempogastoreplicar !== undefined ? loja.tempogastoreplicar : ''}</td>
                    <td>${loja.regintegracao !== undefined ? loja.regintegracao : ''}</td>
                    <td>${loja.versaol || ''}</td>
                    <td>${loja.versaopro || ''}</td>
                    <td>${loja.versaoomnni || ''}</td>
                    <td>${loja.versaolite || ''}</td>
                    <td>${loja.versaoparelelo || ''}</td>
                    <td>${loja.versaodunamis || ''}</td>
                    <td>${loja.versaointegracao || ''}</td>
                    <td>${loja.versaoatualizador || ''}</td>
                    <td>${loja.versaotemp || ''}</td>
                    <td>${loja.ipvpn || ''}</td>
                    <td>${loja.integracao !== undefined ? loja.integracao : ''}</td>
                `;
                // Regra: destacar em vermelho se (reglocal||regintegracao||regservidor > 0) e (ultimoerrorelicar||ultimoerrointegracao != vazio)
                const reglocal = Number(loja.reglocal || 0);
                const regintegracao = Number(loja.regintegracao || 0);
                const regservidor = Number(loja.regservidor || 0);
                const hasRegs = reglocal > 0 || regintegracao > 0 || regservidor > 0;
                const erroReplicar = (loja.ultimoerrorelicar && String(loja.ultimoerrorelicar).trim() !== '');
                const erroIntegracao = (loja.ultimoerrointegracao && String(loja.ultimoerrointegracao).trim() !== '');
                const hasErrors = erroReplicar || erroIntegracao;
                if (hasRegs && hasErrors) {
                    row.classList.add('row-alert');
                } else {
                    // Destacar em azul quando 'replicar' estiver mais de 1 hora atrás do agora
                    const replicarStr = (typeof loja.replicar === 'string') ? loja.replicar.trim() : '';
                    if (replicarStr) {
                        const isoStr = replicarStr.replace(' ', 'T') + '-03:00';
                        const replicarDate = new Date(isoStr);
                        if (!isNaN(replicarDate.getTime())) {
                            const diffMs = Date.now() - replicarDate.getTime();
                            const oneHourMs = 60 * 60 * 1000;
                            if (diffMs > oneHourMs) {
                                row.classList.add('row-replicar-old');
                            }
                        }
                    }
                }
                tableBody.appendChild(row);
            });
        }
        
        // Função para aplicar os filtros
        function applyFilters() {
            const search = document.getElementById('searchFilter').value.toLowerCase().trim();
            const filteredLojas = allLojas.filter(loja => {
                if (!search) return true;
                const bancoMatch = !!(loja.banco && loja.banco.toLowerCase().includes(search));
                const lojaMatch = !!(loja.loja && loja.loja.toLowerCase().includes(search));
                return bancoMatch || lojaMatch;
            });
            displayLojas(filteredLojas);
        }
        
        // Função para limpar os filtros
        function clearFilters() {
            document.getElementById('searchFilter').value = '';
            displayLojas(allLojas);
        }
        
        // Função de debounce para filtrar em tempo real
        function debounce(fn, delay = 300) {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...args), delay);
            };
        }
        
        // Carregar os dados quando a página for carregada
        document.addEventListener('DOMContentLoaded', () => {
            loadLojas();
            const input = document.getElementById('searchFilter');
            if (input) {
                const debouncedApplyFilters = debounce(applyFilters, 300);
                input.addEventListener('input', debouncedApplyFilters);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyFilters();
                    }
                });
            }
            // Auto-atualização a cada 60 segundos, sem piscar "carregando"
            setInterval(() => {
                loadLojas(true);
            }, 60000);
        });
    </script>
</body>
</html>