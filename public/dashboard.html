<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Lojas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .filters {
            background-color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            margin-bottom: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .filter-row {
            display: flex;
            gap: 12px;
            margin-bottom: 0;
            align-items: center;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        .filter-group label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        .filter-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
        }
        .filter-input {
            padding: 12px 14px;
            height: 42px;
            font-size: 16px;
            line-height: 22px;
            border: 1px solid #cfd8dc;
            border-radius: 10px;
            flex: 1;
            background-color: #fff;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            overflow-y: auto;
        }
        .filter-input::placeholder {
            color: #9aa0a6;
        }
        .filter-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
            background-color: #fff;
        }
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }
        .theme-icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 10px;
            min-width: 40px;
            height: 40px;
            border-radius: 10px;
        }
        .theme-icon-btn .icon {
            width: 18px;
            height: 18px;
            stroke-width: 1.8;
        }
        .theme-icon-btn .icon-sun { display: none; }
        .theme-icon-btn .icon-moon { display: inline; }
        body.dark .theme-icon-btn .icon-sun { display: inline; }
        body.dark .theme-icon-btn .icon-moon { display: none; }
        .filter-btn {
            background-color: #7a82ff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
        }
        .filter-btn:hover {
            background-color: #6b73f0;
        }
        .clear-btn {
            background-color: #f44336;
        }
        .clear-btn:hover {
            background-color: #d32f2f;
        }
        table {
            width: max-content;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            table-layout: auto;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
            min-width: 140px;
        }
        th {
            background-color: #7a82ff;
            color: white;
            position: sticky;
            top: 0;
        }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background-color: #6b73f0; }
        th .sort-indicator { margin-left: 6px; font-size: 12px; opacity: 0.75; }
        tr:hover {
            background-color: #f5f5f5;
        }
        tr.selected {
            background-color: #e8f5e8 !important;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        body.dark tr.selected {
            background-color: #2d4a2d !important;
            border-left: 4px solid #66bb6a;
            box-shadow: 0 2px 8px rgba(102, 187, 106, 0.3);
        }
        .row-alert {
            background-color: #ffebee !important;
            color: #b00020;
        }
        .row-replicar-old {
            background-color: #e3f2fd !important;
            color: #0d47a1 !important;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
        .error {
            color: red;
            text-align: center;
            padding: 20px;
        }
        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            height: calc(100vh - 160px);
            -webkit-overflow-scrolling: touch;
        }
        /* Scrollbar (WebKit) */
        .table-container::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #eee;
            border-radius: 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #bbb;
            border-radius: 8px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a6a6a6;
        }
        @media (max-width: 1024px) {
            th, td { min-width: 120px; }
        }
        @media (max-width: 768px) {
            body { padding: 12px; }
            .filters { padding: 10px 12px; margin-bottom: 8px; border-radius: 8px; }
            .filter-row { gap: 10px; }
            .filter-input { font-size: 14px; height: 40px; }
            th, td { min-width: 110px; padding: 6px; }
        }
        @media (max-width: 480px) {
            .filter-input { font-size: 14px; height: 38px; }
            th, td { min-width: 100px; }
        }
        /* Tema escuro overrides */
        body.dark {
            background-color: #0f1115;
            color: #e0e6f0;
        }
        body.dark .filters {
            background-color: #141821;
            box-shadow: none;
            border: 1px solid #2a3445;
        }
        body.dark .filter-input {
            background-color: #0f1115;
            border-color: #2a3445;
            color: #e0e6f0;
        }
        body.dark .filter-input::placeholder {
            color: #8aa1b7;
        }
        body.dark .filter-input:focus {
            border-color: #2e7d32;
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.2);
            background-color: #0f1115;
        }
        body.dark .filter-btn {
            background-color: #8b7afc;
        }
        body.dark .filter-btn:hover {
            background-color: #7a69f2;
        }
        body.dark .clear-btn {
            background-color: #c62828;
        }
        body.dark .clear-btn:hover {
            background-color: #8e0000;
        }
        body.dark table {
            background-color: #141821;
            box-shadow: none;
        }
        body.dark th {
            background-color: #8b7afc;
            color: #e0e6f0;
        }
        body.dark th.sortable:hover { background-color: #7a69f2; }
        body.dark td, body.dark th {
            border-bottom: 1px solid #2a3445;
        }
        body.dark tr:hover {
            background-color: #1b2130;
        }
        body.dark .row-alert {
            background-color: #3b0d0d !important;
            color: #ff6b6b !important;
        }
        body.dark .row-replicar-old {
            background-color: #0d2538 !important;
            color: #90caf9 !important;
        }
        body.dark .table-container::-webkit-scrollbar-track {
            background: #1e2633;
        }
        body.dark .table-container::-webkit-scrollbar-thumb {
            background: #2a3445;
        }
        body.dark .table-container::-webkit-scrollbar-thumb:hover {
            background: #3c4a5e;
        }
        /* Painel de colunas */
        .columns-panel {
            display: none;
            position: absolute;
            right: 16px;
            top: 66px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            padding: 10px;
            width: 280px;
            z-index: 20;
        }
        .columns-panel.open { display: block; }
        .columns-panel h3 { margin: 6px 0 8px; font-size: 14px; }
        .columns-list { max-height: 260px; overflow-y: auto; padding-right: 6px; }
        .columns-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; }
        .drag-handle { cursor: grab; user-select: none; color: #666; }
        .columns-actions { display: flex; justify-content: space-between; margin-top: 8px; }
        .columns-actions button { padding: 6px 10px; border-radius: 6px; border: 1px solid #ddd; background: #fafafa; cursor: pointer; }
        .columns-actions button:hover { background: #f0f0ff; border-color: #cbd0ff; }
        body.dark .columns-panel { background: #141821; border-color: #2a3445; }
        body.dark .columns-actions button { background: #0f1115; border-color: #2a3445; color: #e0e6f0; }
        body.dark .columns-actions button:hover { background: #1b2130; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Filtros -->
        <div class="filters">
            <div class="filter-row">
                <input type="text" id="searchFilter" class="filter-input" placeholder="Filtrar por banco ou loja...">
                <div class="filter-buttons">
                    <button id="toggleTheme" class="filter-btn theme-icon-btn" type="button" aria-label="Alternar tema" title="Alternar tema">
                        <svg class="icon icon-sun" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="4"></circle>
                            <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"></path>
                        </svg>
                        <svg class="icon icon-moon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </button>
                    <!-- Gerenciar colunas -->
                    <button id="manageColumns" class="filter-btn" type="button" title="Colunas">Colunas</button>
                </div>
            </div>
        </div>
    </div>
        
        <div class="table-container">
            <table id="lojasTable">
                <thead>
                    <tr id="lojasHeaderRow"></tr>
                </thead>
                <tbody id="lojasTableBody">
                    <tr>
                        <td colspan="25" class="loading">Carregando dados...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Variável para armazenar todos os dados
        let allLojas = [];
        
        // Aplicar ordenação por cor somente na primeira chamada
        let firstSortApplied = false;
        let currentSort = { key: null, direction: 'asc' };
        
        // Definição de colunas (ordem e rótulos)
        const defaultColumns = [
          { key: 'id', label: 'ID' },
          { key: 'idloja', label: 'ID Loja' },
          { key: 'banco', label: 'Banco' },
          { key: 'backup', label: 'Backup' },
          { key: 'loja', label: 'Loja' },
          { key: 'ultimoerrorelicar', label: 'Último Erro Replicar' },
          { key: 'ultimoerrointegracao', label: 'Último Erro Integração' },
          { key: 'qdtregistrosreplicar', label: 'Qtd Registros Replicar' },
          { key: 'replicar', label: 'Replicar' },
          { key: 'reglocal', label: 'Reg Local' },
          { key: 'regservidor', label: 'Reg Servidor' },
          { key: 'versaosinc', label: 'Versão Sinc' },
          { key: 'tempogastoreplicar', label: 'Tempo Gasto Replicar' },
          { key: 'regintegracao', label: 'Reg Integração' },
          { key: 'versaol', label: 'Versão L' },
          { key: 'versaopro', label: 'Versão Pro' },
          { key: 'versaoomnni', label: 'Versão Omnni' },
          { key: 'versaolite', label: 'Versão Lite' },
          { key: 'versaoparelelo', label: 'Versão Paralelo' },
          { key: 'versaodunamis', label: 'Versão Dunamis' },
          { key: 'versaointegracao', label: 'Versão Integração' },
          { key: 'versaoatualizador', label: 'Versão Atualizador' },
          { key: 'versaotemp', label: 'Versão Temp' },
          { key: 'ipvpn', label: 'IP VPN' },
          { key: 'integracao', label: 'Integração' },
        ];
        const STORAGE_ORDER = 'dashboard.columnsOrder';
        const STORAGE_VISIBLE = 'dashboard.visibleColumns';
        let columnsOrder = [];
        let visibleColumns = new Set();
        
        function loadColumnPrefs() {
          try {
            const savedOrder = JSON.parse(localStorage.getItem(STORAGE_ORDER) || 'null');
            const savedVisible = JSON.parse(localStorage.getItem(STORAGE_VISIBLE) || 'null');
            const defaultOrder = defaultColumns.map(c => c.key);
            columnsOrder = Array.isArray(savedOrder) ? savedOrder.filter(k => defaultOrder.includes(k)) : defaultOrder;
            visibleColumns = new Set(Array.isArray(savedVisible) ? savedVisible.filter(k => defaultOrder.includes(k)) : defaultOrder);
            // Salvaguarda: evitar estado sem colunas visíveis ou sem ordem
            if (!columnsOrder.length) columnsOrder = defaultOrder;
            if (visibleColumns.size === 0) visibleColumns = new Set(defaultOrder);
          } catch (_) {
            columnsOrder = defaultColumns.map(c => c.key);
            visibleColumns = new Set(columnsOrder);
          }
        }
        function saveColumnPrefs() {
          localStorage.setItem(STORAGE_ORDER, JSON.stringify(columnsOrder));
          localStorage.setItem(STORAGE_VISIBLE, JSON.stringify(Array.from(visibleColumns)));
        }
        function buildHeader() {
          const theadRow = document.getElementById('lojasHeaderRow');
          if (!theadRow) return;
          theadRow.innerHTML = '';
          const frag = document.createDocumentFragment();
          columnsOrder.forEach(key => {
            if (!visibleColumns.has(key)) return;
            const col = defaultColumns.find(c => c.key === key);
            const th = document.createElement('th');
            th.className = 'sortable';
            th.dataset.key = key;
            th.draggable = true;
            th.textContent = col ? col.label : key;
            const span = document.createElement('span');
            span.className = 'sort-indicator';
            th.appendChild(document.createTextNode(' '));
            th.appendChild(span);
            frag.appendChild(th);
          });
          theadRow.appendChild(frag);
          setupSorting();
          enableHeaderDrag();
          updateSortIndicators();
        }
        function enableHeaderDrag() {
          const headers = document.querySelectorAll('#lojasTable thead th.sortable');
          let draggedKey = null;
          headers.forEach(th => {
            th.addEventListener('dragstart', (e) => {
              draggedKey = th.dataset.key;
              e.dataTransfer.effectAllowed = 'move';
            });
            th.addEventListener('dragover', (e) => {
              e.preventDefault();
              e.dataTransfer.dropEffect = 'move';
            });
            th.addEventListener('drop', (e) => {
              e.preventDefault();
              const targetKey = th.dataset.key;
              if (!draggedKey || !targetKey || draggedKey === targetKey) return;
              const from = columnsOrder.indexOf(draggedKey);
              const to = columnsOrder.indexOf(targetKey);
              if (from < 0 || to < 0) return;
              columnsOrder.splice(from, 1);
              columnsOrder.splice(to, 0, draggedKey);
              saveColumnPrefs();
              buildHeader();
              const input = document.getElementById('searchFilter');
              const hasSearch = input && input.value.trim().length > 0;
              if (hasSearch) {
                applyFilters();
              } else {
                displayLojas(sortActiveOrColor(allLojas));
              }
            });
          });
        }
        function buildColumnsPanel() {
          const panelId = 'columnsPanel';
          let panel = document.getElementById(panelId);
          if (!panel) {
            panel = document.createElement('div');
            panel.id = panelId;
            panel.className = 'columns-panel';
            panel.innerHTML = `<h3>Colunas</h3><div class="columns-list" id="columnsList"></div><div class="columns-actions"><button id="resetCols">Resetar</button><button id="closeCols">Fechar</button></div>`;
            document.body.appendChild(panel);
          }
          const list = document.getElementById('columnsList');
          list.innerHTML = '';
          columnsOrder.forEach(key => {
            const col = defaultColumns.find(c => c.key === key);
            const item = document.createElement('div');
            item.className = 'columns-item';
            item.innerHTML = `<span class="drag-handle">☰</span><label style="flex:1"><input type="checkbox" ${visibleColumns.has(key) ? 'checked' : ''} data-key="${key}"> ${col ? col.label : key}</label>`;
            list.appendChild(item);
          });
          list.querySelectorAll('input[type="checkbox"]').forEach(inp => {
            inp.addEventListener('change', (e) => {
              const k = inp.getAttribute('data-key');
              if (!k) return;
              if (inp.checked) visibleColumns.add(k); else visibleColumns.delete(k);
              saveColumnPrefs();
              buildHeader();
              const input = document.getElementById('searchFilter');
              const hasSearch = input && input.value.trim().length > 0;
              if (hasSearch) { applyFilters(); } else { displayLojas(sortActiveOrColor(allLojas)); }
            });
          });
          document.getElementById('resetCols').onclick = () => {
            columnsOrder = defaultColumns.map(c => c.key);
            visibleColumns = new Set(columnsOrder);
            saveColumnPrefs();
            buildColumnsPanel();
            buildHeader();
            displayLojas(sortActiveOrColor(allLojas));
          };
          document.getElementById('closeCols').onclick = () => {
            panel.classList.remove('open');
          };
          return panel;
        }
        
        function isRowAlertRed(loja) {
            const reglocal = Number(loja.reglocal || 0);
            const regintegracao = Number(loja.regintegracao || 0);
            const regservidor = Number(loja.regservidor || 0);
            const hasRegs = reglocal > 0 || regintegracao > 0 || regservidor > 0;
            const erroReplicar = (loja.ultimoerrorelicar && String(loja.ultimoerrorelicar).trim() !== '');
            const erroIntegracao = (loja.ultimoerrointegracao && String(loja.ultimoerrointegracao).trim() !== '');
            const hasErrors = erroReplicar || erroIntegracao;
            return hasRegs && hasErrors;
        }
        
        function isReplicarOld(loja) {
            const replicarStr = (typeof loja.replicar === 'string') ? loja.replicar.trim() : '';
            if (!replicarStr) return false;
            const isoStr = replicarStr.replace(' ', 'T') + '-03:00';
            const replicarDate = new Date(isoStr);
            if (isNaN(replicarDate.getTime())) return false;
            const diffMs = Date.now() - replicarDate.getTime();
            const oneHourMs = 60 * 60 * 1000;
            return diffMs > oneHourMs;
        }
        
        function sortLojasByColor(lojas) {
            const reds = [];
            const blues = [];
            const normals = [];
            for (const loja of lojas) {
                if (isRowAlertRed(loja)) {
                    reds.push(loja);
                } else if (isReplicarOld(loja)) {
                    blues.push(loja);
                } else {
                    normals.push(loja);
                }
            }
            return reds.concat(blues, normals);
        }
        
        // Função para carregar os dados das lojas
        async function loadLojas(silent = false) {
            const tableBody = document.getElementById('lojasTableBody');
            if (!silent) {
                tableBody.innerHTML = '<tr><td colspan="25" class="loading">Carregando dados...</td></tr>';
            }
            
            try {
                const response = await fetch('/lojas?limit=10000');
                const data = await response.json();
                
                if (data.success) {
                    allLojas = data.result;
                    // Ordenar por cor na primeira chamada: vermelho > azul > normal
                    if (!silent && !firstSortApplied) {
                        allLojas = sortLojasByColor(allLojas);
                        firstSortApplied = true;
                    }
                    // Aplicar mesma ordenação também nos refreshs (silent)
                    if (silent) {
                        allLojas = sortActiveOrColor(allLojas);
                    }
                    const input = document.getElementById('searchFilter');
                    const hasSearch = input && input.value.trim().length > 0;
                    if (hasSearch) {
                        applyFilters();
                    } else {
                        displayLojas(sortActiveOrColor(allLojas));
                    }
                } else {
                    if (!silent) {
                        tableBody.innerHTML = '<tr><td colspan="25" class="error">Erro ao carregar dados: ' + (data.errors ? data.errors[0].message : 'Erro desconhecido') + '</td></tr>';
                    }
                }
            } catch (error) {
                if (!silent) {
                    tableBody.innerHTML = '<tr><td colspan="25" class="error">Erro ao carregar dados: ' + error.message + '</td></tr>';
                }
            }
        }
        
        // Função para exibir as lojas na tabela
        function displayLojas(lojas) {
            const tableBody = document.getElementById('lojasTableBody');
            
            if (lojas.length === 0) {
                const visibleCount = columnsOrder.filter(k => visibleColumns.has(k)).length || 1;
                tableBody.innerHTML = `<tr><td colspan="${visibleCount}" class="loading">Nenhuma loja encontrada.</td></tr>`;
                return;
            }
            
            // Limpar a tabela
            tableBody.innerHTML = '';
            
            const numericKeys = new Set(['id','idloja','qdtregistrosreplicar','reglocal','regservidor','tempogastoreplicar','regintegracao','integracao']);
            lojas.forEach(loja => {
                const row = document.createElement('tr');
                const cells = [];
                columnsOrder.forEach(key => {
                  if (!visibleColumns.has(key)) return;
                  if (numericKeys.has(key)) {
                    const v = loja[key];
                    cells.push(`<td>${v !== undefined && v !== null ? v : ''}</td>`);
                  } else {
                    cells.push(`<td>${loja[key] || ''}</td>`);
                  }
                });
                row.innerHTML = cells.join('');
                
                // Adicionar event listener para seleção de linha
                row.addEventListener('click', function(e) {
                    // Remover seleção de todas as outras linhas
                    document.querySelectorAll('#lojasTableBody tr.selected').forEach(r => {
                        r.classList.remove('selected');
                    });
                    // Adicionar seleção à linha clicada
                    this.classList.add('selected');
                });
                
                // Destacar por alertas
                if (isRowAlertRed(loja)) {
                    row.classList.add('row-alert');
                } else {
                    const replicarStr = (typeof loja.replicar === 'string') ? loja.replicar.trim() : '';
                    if (replicarStr) {
                        const isoStr = replicarStr.replace(' ', 'T') + '-03:00';
                        const replicarDate = new Date(isoStr);
                        if (!isNaN(replicarDate.getTime())) {
                            const diffMs = Date.now() - replicarDate.getTime();
                            const oneHourMs = 60 * 60 * 1000;
                            if (diffMs > oneHourMs) {
                                row.classList.add('row-replicar-old');
                            }
                        }
                    }
                }
                tableBody.appendChild(row);
            });
        }
        
        // Função para aplicar os filtros
        function applyFilters() {
            const search = document.getElementById('searchFilter').value.toLowerCase().trim();
            const filteredLojas = allLojas.filter(loja => {
                if (!search) return true;
                const bancoMatch = !!(loja.banco && loja.banco.toLowerCase().includes(search));
                const lojaMatch = !!(loja.loja && loja.loja.toLowerCase().includes(search));
                return bancoMatch || lojaMatch;
            });
            displayLojas(sortActiveOrColor(filteredLojas));
        }
        
        // Função para limpar os filtros
        function clearFilters() {
            document.getElementById('searchFilter').value = '';
            displayLojas(sortActiveOrColor(allLojas));
        }
        
        // Função de debounce para filtrar em tempo real
        function debounce(fn, delay = 300) {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...args), delay);
            };
        }
        
        // Helpers de ordenação por clique no cabeçalho
        function parseDateBR(str, hasTime = false) {
            const s = String(str || '').trim();
            if (!s) return NaN;
            const iso = hasTime ? s.replace(' ', 'T') + '-03:00' : s + 'T00:00:00-03:00';
            const d = new Date(iso);
            return d.getTime();
        }
        const numericKeys = new Set(['id','idloja','qdtregistrosreplicar','reglocal','regservidor','tempogastoreplicar','regintegracao','integracao']);
        const timeKeys = new Set(['replicar']);
        const dateKeys = new Set(['backup']);
        function getComparable(loja, key) {
            if (numericKeys.has(key)) {
                const n = Number(loja[key]);
                return Number.isFinite(n) ? n : null;
            }
            if (timeKeys.has(key)) {
                const t = parseDateBR(loja[key], true);
                return Number.isFinite(t) ? t : null;
            }
            if (dateKeys.has(key)) {
                const t = parseDateBR(loja[key], false);
                return Number.isFinite(t) ? t : null;
            }
            const s = (loja[key] ?? '').toString().toLowerCase();
            return s || null;
        }
        function compareValues(va, vb, direction) {
            const isNullA = va === null || va === undefined || (typeof va === 'number' && !Number.isFinite(va)) || (typeof va === 'string' && va === '');
            const isNullB = vb === null || vb === undefined || (typeof vb === 'number' && !Number.isFinite(vb)) || (typeof vb === 'string' && vb === '');
            if (isNullA && isNullB) return 0;
            if (isNullA) return 1; // nulos sempre no fim
            if (isNullB) return -1;
            const mult = direction === 'asc' ? 1 : -1;
            if (typeof va === 'number' && typeof vb === 'number') {
                if (va === vb) return 0;
                return mult * (va > vb ? 1 : -1);
            }
            return mult * String(va).localeCompare(String(vb), 'pt-BR', { numeric: true, sensitivity: 'base' });
        }
        function sortByKey(lojas, key, direction) {
            return [...lojas].sort((a, b) => compareValues(getComparable(a, key), getComparable(b, key), direction));
        }
        function sortActiveOrColor(lojas) {
            if (currentSort.key) return sortByKey(lojas, currentSort.key, currentSort.direction);
            return sortLojasByColor(lojas);
        }
        function updateSortIndicators() {
            const headers = document.querySelectorAll('#lojasTable thead th.sortable');
            headers.forEach(th => {
                const span = th.querySelector('.sort-indicator');
                if (!span) return;
                if (th.dataset.key === currentSort.key) {
                    span.textContent = currentSort.direction === 'asc' ? '▲' : '▼';
                    span.style.opacity = '1';
                } else {
                    span.textContent = '';
                    span.style.opacity = '0.75';
                }
            });
        }
        function setupSorting() {
            const headers = document.querySelectorAll('#lojasTable thead th.sortable');
            headers.forEach(th => th.addEventListener('click', () => {
                const key = th.dataset.key;
                if (!key) return;
                if (currentSort.key === key) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort = { key, direction: 'asc' };
                }
                updateSortIndicators();
                const input = document.getElementById('searchFilter');
                const hasSearch = input && input.value.trim().length > 0;
                if (hasSearch) {
                    applyFilters();
                } else {
                    displayLojas(sortActiveOrColor(allLojas));
                }
            }));
            updateSortIndicators();
        }
        
        // Função de debounce para filtrar em tempo real
        function debounce(fn, delay = 300) {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...args), delay);
            };
        }
        
        // Carregar os dados quando a página for carregada
        document.addEventListener('DOMContentLoaded', () => {
            loadColumnPrefs();
            buildHeader();
            const panel = buildColumnsPanel();
            const manageBtn = document.getElementById('manageColumns');
            if (manageBtn) {
              manageBtn.addEventListener('click', () => {
                panel.classList.toggle('open');
              });
            }
            
            // Event listener para desselecionar linha ao clicar fora da tabela
            document.addEventListener('click', (e) => {
                const table = document.getElementById('lojasTable');
                const columnsPanel = document.getElementById('columnsPanel');
                
                // Se o clique não foi na tabela nem no painel de colunas
                if (table && !table.contains(e.target) && 
                    columnsPanel && !columnsPanel.contains(e.target) &&
                    !e.target.closest('#manageColumns')) {
                    // Remover seleção de todas as linhas
                    document.querySelectorAll('#lojasTableBody tr.selected').forEach(r => {
                        r.classList.remove('selected');
                    });
                }
            });
            
            loadLojas();
            const input = document.getElementById('searchFilter');
            if (input) {
                const debouncedApplyFilters = debounce(applyFilters, 300);
                input.addEventListener('input', debouncedApplyFilters);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyFilters();
                    }
                });
            }
            setInterval(() => { loadLojas(true); }, 60000);
            const themeBtn = document.getElementById('toggleTheme');
            function applyTheme(theme) {
                document.body.classList.toggle('dark', theme === 'dark');
                try { localStorage.setItem('theme', theme); } catch (e) {}
            }
            const savedTheme = (function(){ try { return localStorage.getItem('theme') || 'light'; } catch(e) { return 'light'; } })();
            applyTheme(savedTheme);
            if (themeBtn) {
                themeBtn.addEventListener('click', () => {
                    const isDark = document.body.classList.contains('dark');
                    applyTheme(isDark ? 'light' : 'dark');
                });
            }
            // setupSorting já é chamado em buildHeader()
        });
    </script>
</body>
</html>